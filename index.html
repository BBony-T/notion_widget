<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion Calendar Widgets Gallery – v2</title>
<style>
  :root{
    --bg:#ffffff; --fg:#0f172a; --muted:#e5e7eb; --sub:#64748b; --accent:#2563eb; --card:#ffffff; --chip:#f3f4f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--fg)}
  .wrap{max-width:1100px; margin:0 auto; padding:14px}
  h1{font-size:20px; margin:0 0 4px; font-weight:800}
  .sub{font-size:12px; color:var(--sub); margin-bottom:8px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  select,input,button{font-size:14px; padding:8px 10px; border:1px solid var(--muted); border-radius:10px; background:#fff}
  button.primary{background:var(--accent); color:#fff; border:none}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
  .tab{appearance:none; border:1px solid var(--muted); background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700}
  .tab[aria-selected="true"]{background:var(--accent); color:#fff; border-color:var(--accent)}
  .panel{border:1px solid var(--muted); border-radius:16px; padding:12px; background:var(--card)}
  .grid{display:grid; gap:10px}
  .legend{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0}
  .badge{display:inline-flex; align-items:center; gap:6px; background:var(--chip); border-radius:999px; padding:4px 8px; font-size:12px}
  .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
  .ev{border:1px solid var(--muted); border-radius:12px; padding:8px; display:grid; grid-template-columns:auto 1fr; gap:10px}
  .time{font-variant-numeric:tabular-nums; font-weight:700}
  .ev-title{font-weight:800}
  .muted{color:var(--sub)}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px}
  .hr{height:1px; background:var(--muted); margin:12px 0}
  /* Weekly board */
  .week{display:grid; gap:8px}
  @media(min-width:900px){.week{grid-template-columns: repeat(7, 1fr)}}
  .col{border:1px solid var(--muted); border-radius:12px; padding:8px; min-height:140px}
  .col h3{margin:0 0 6px; font-size:14px}
  .chip{display:inline-block; background:var(--chip); border-radius:8px; padding:4px 6px; font-size:12px; margin:4px 0}
  /* Mini month */
  .month{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
  .cell{border:1px solid var(--muted); border-radius:10px; padding:6px; min-height:64px; position:relative}
  .cell .d{font-size:12px; font-weight:800}
  .pips{position:absolute; right:6px; bottom:6px; display:flex; gap:4px}
  .list{display:flex; flex-direction:column; gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1 id="title">캘린더 위젯 컬렉션</h1>
    <div class="row" style="gap:6px">
      <select id="daysSel"><option value="7">7일</option><option value="14" selected>14일</option><option value="30">30일</option></select>
      <button class="primary" id="reload">새로고침</button>
    </div>
  </div>
  <div class="sub" id="desc">Asia/Seoul 기준 • URL 파라미터: <code>calendarId, proxy|apiKey, days, title, theme, maxPerDay, map</code></div>

  <div class="legend" id="legend"></div>

  <div class="tabs" role="tablist">
    <button class="tab" id="tab1" role="tab" aria-selected="true" aria-controls="p1">리스트형</button>
    <button class="tab" id="tab2" role="tab" aria-selected="false" aria-controls="p2">주간 보드(열형)</button>
    <button class="tab" id="tab3" role="tab" aria-selected="false" aria-controls="p3">미니 월력 + 리스트</button>
  </div>

  <section class="panel" id="p1" role="tabpanel" aria-labelledby="tab1">
    <div id="listView" class="grid"></div>
  </section>

  <section class="panel" id="p2" role="tabpanel" aria-labelledby="tab2" hidden>
    <div id="weekView" class="week"></div>
  </section>

  <section class="panel" id="p3" role="tabpanel" aria-labelledby="tab3" hidden>
    <div class="grid" style="grid-template-columns: 1fr; gap:12px">
      <div class="month" id="monthGrid"></div>
      <div class="list" id="miniList"></div>
    </div>
  </section>
</div>

<script>
/**
 * Notion Calendar Widgets Gallery – v2
 * Views: List, Weekly board, Mini-month + list
 * URL params:
 *  - calendarId: Google Calendar ID (예: abc@group.calendar.google.com)
 *  - proxy: Vercel serverless endpoint (권장)  또는  apiKey: Google API key + 공개 캘린더
 *  - days: 기본 14
 *  - title: 페이지 상단 제목
 *  - theme: light|slate|emerald|rose|violet
 *  - maxPerDay: 리스트형/주간형에서 하루 최대 표시 수(기본 8)
 *  - map: 색상 매핑 규칙. 예: map=1:회의:#3b82f6,2:행사:#ef4444,default:일반:#64748b
 */
const qs = new URLSearchParams(location.search);
const CAL_ID = qs.get('calendarId') || 'primary';
const DAYS = Math.max(1, parseInt(qs.get('days')||'14',10));
const TITLE = qs.get('title') || '캘린더 위젯 컬렉션';
const THEME = (qs.get('theme')||'light').toLowerCase();
const MAX_PER_DAY = Math.max(1, parseInt(qs.get('maxPerDay')||'8',10));

// Theme presets
const themes={
  light:{bg:'#ffffff', fg:'#0f172a', muted:'#e5e7eb', sub:'#64748b', accent:'#2563eb', card:'#ffffff', chip:'#f3f4f6'},
  slate:{bg:'#0b1220', fg:'#e5ecff', muted:'#20304f', sub:'#94a3b8', accent:'#7aa2ff', card:'#0f172a', chip:'#1f2a44'},
  emerald:{bg:'#ffffff', fg:'#064e3b', muted:'#d1fae5', sub:'#10b981', accent:'#059669', card:'#ffffff', chip:'#ecfdf5'},
  rose:{bg:'#ffffff', fg:'#3f1d2e', muted:'#ffe4e6', sub:'#fb7185', accent:'#e11d48', card:'#ffffff', chip:'#fff1f2'},
  violet:{bg:'#ffffff', fg:'#2e1065', muted:'#ede9fe', sub:'#8b5cf6', accent:'#7c3aed', card:'#ffffff', chip:'#f5f3ff'},
};
if(themes[THEME]){
  const t=themes[THEME];
  for(const k in t){ document.documentElement.style.setProperty('--'+k, t[k]); }
}

// Title & days selector
const titleEl=document.getElementById('title'); titleEl.textContent = TITLE;
const daysSel=document.getElementById('daysSel'); daysSel.value=String(DAYS);

// Tabs
const tabs=[document.getElementById('tab1'),document.getElementById('tab2'),document.getElementById('tab3')];
const panels=[document.getElementById('p1'),document.getElementById('p2'),document.getElementById('p3')];
function selTab(i){ tabs.forEach((b,j)=>{ b.setAttribute('aria-selected', j===i); }); panels.forEach((p,j)=>{ p.hidden = j!==i; }); }
for(let i=0;i<tabs.length;i++){ tabs[i].addEventListener('click',()=>selTab(i)); }

// Mapping parser: "1:회의:#3b82f6,2:행사:#ef4444,default:일반:#64748b"
function parseMap(){
  const s = qs.get('map')||''; const out = new Map(); let def={name:'일정', color:'#64748b'};
  s.split(',').map(x=>x.trim()).filter(Boolean).forEach(pair=>{
    const [id,name,color] = pair.split(':');
    if(id==='default'){ def={name: name||'일정', color: color||'#64748b'}; return; }
    if(!id) return; out.set(String(id), {name: name||('색상 '+id), color: color||'#64748b'});
  });
  return {map:out, def};
}
const cmap = parseMap();

// Utils
const $ = s=>document.querySelector(s);
function fmtDate(d){ return new Intl.DateTimeFormat('ko-KR',{weekday:'short', month:'numeric', day:'numeric'}).format(d); }
function fmtTime(d){ return new Intl.DateTimeFormat('ko-KR',{hour:'2-digit', minute:'2-digit', hour12:false}).format(d); }
function dayKey(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }

function colorOf(ev){
  const id = ev.colorId ? String(ev.colorId) : 'default';
  return cmap.map.get(id) || cmap.def;
}

function buildLegend(sampleItems){
  const legend = document.getElementById('legend');
  const seen = new Map();
  sampleItems.forEach(ev=>{ const {name,color} = colorOf(ev); seen.set(name, color); });
  // Always include default
  seen.set(cmap.def.name, cmap.def.color);
  legend.innerHTML = '';
  for(const [name,color] of seen.entries()){
    const span = document.createElement('span'); span.className='badge';
    span.innerHTML = `<span class="dot" style="background:${color}"></span>${name}`;
    legend.appendChild(span);
  }
}

async function fetchEvents(days){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = new Date(start.getTime() + days*86400000);
  const proxy = qs.get('proxy');
  if(proxy){
    const url = new URL(proxy);
    url.searchParams.set('calendarId', CAL_ID);
    url.searchParams.set('timeMin', start.toISOString());
    url.searchParams.set('timeMax', end.toISOString());
    url.searchParams.set('maxResults', String(days*10));
    const r = await fetch(url); if(!r.ok) throw new Error('프록시 오류');
    const data = await r.json();
    return { items: data.items||[], start, end };
  }
  const apiKey = qs.get('apiKey');
  const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CAL_ID)}/events`);
  url.searchParams.set('singleEvents','true');
  url.searchParams.set('orderBy','startTime');
  url.searchParams.set('timeMin', start.toISOString());
  url.searchParams.set('timeMax', end.toISOString());
  url.searchParams.set('maxResults', String(days*10));
  if(apiKey) url.searchParams.set('key', apiKey);
  const r = await fetch(url); if(!r.ok) throw new Error('API 오류');
  const data = await r.json();
  return { items: data.items||[], start, end };
}

function groupByDay(items){
  const map = new Map();
  items.forEach(ev=>{
    const start = new Date(ev.start.dateTime || ev.start.date);
    const key = dayKey(start);
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(ev);
  });
  // sort each day's events by start time
  map.forEach(list=> list.sort((a,b)=> new Date(a.start.dateTime||a.start.date) - new Date(b.start.dateTime||b.start.date)) );
  return map;
}

function renderList(items){
  const parent = document.getElementById('listView');
  parent.innerHTML = '';
  const by = groupByDay(items);
  const days = Array.from(by.keys()).sort();
  days.forEach(k=>{
    const d = new Date(k);
    const card = document.createElement('div'); card.style.border='1px solid var(--muted)'; card.style.borderRadius='14px'; card.style.padding='10px';
    const h = document.createElement('h3'); h.textContent = fmtDate(d); h.style.margin='0 0 8px';
    card.appendChild(h);
    by.get(k).slice(0, MAX_PER_DAY).forEach(ev=>{
      const row = document.createElement('div'); row.className='ev';
      const allDay = !!ev.start.date;
      const s = new Date(ev.start.dateTime || ev.start.date);
      const e = new Date(ev.end?.dateTime || ev.end?.date || ev.start.dateTime || ev.start.date);
      const t = document.createElement('div'); t.className='time'; t.textContent = allDay ? '종일' : `${fmtTime(s)}\n~ ${fmtTime(e)}`;
      const m = document.createElement('div');
      const title = document.createElement('div'); title.className='ev-title'; title.textContent = ev.summary || '(제목 없음)';
      const meta = document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px';
      const {name,color} = colorOf(ev);
      const tag = document.createElement('span'); tag.className='badge'; tag.innerHTML = `<span class='dot' style='background:${color}'></span>${name}`;
      const arr=[]; if(ev.location) arr.push('장소: '+ev.location); if(ev.organizer?.displayName) arr.push('주최: '+ev.organizer.displayName);
      meta.textContent = arr.join('  •  ');
      const links = document.createElement('div'); links.style.marginTop='4px';
      if(ev.hangoutLink){ const a=document.createElement('a'); a.href=ev.hangoutLink; a.target='_blank'; a.rel='noopener'; a.textContent='Meet'; a.className='pill'; links.appendChild(a); }
      if(ev.htmlLink){ const a=document.createElement('a'); a.href=ev.htmlLink; a.target='_blank'; a.rel='noopener'; a.textContent='캘린더'; a.style.marginLeft='6px'; a.className='pill'; links.appendChild(a); }
      m.appendChild(title); m.appendChild(tag); if(arr.length) m.appendChild(meta); if(links.childNodes.length) m.appendChild(links);
      row.appendChild(t); row.appendChild(m); card.appendChild(row);
    });
    parent.appendChild(card);
  });
}

function startOfWeek(d){
  const x = new Date(d); const day = x.getDay(); // 0=Sun
  const diff = (day===0? -6 : 1-day); // Monday as first day
  x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x;
}

function renderWeekBoard(items){
  const parent = document.getElementById('weekView'); parent.innerHTML='';
  const now = new Date();
  const monday = startOfWeek(now);
  const cols=[]; for(let i=0;i<7;i++){ const d=new Date(monday.getTime()+i*86400000); const k=dayKey(d); cols.push({date:d, key:k, items:[]}); }
  items.forEach(ev=>{ const s=new Date(ev.start.dateTime || ev.start.date); const k=dayKey(s); const c=cols.find(x=>x.key===k); if(c) c.items.push(ev); });
  cols.forEach(c=>{ c.items.sort((a,b)=> new Date(a.start.dateTime||a.start.date) - new Date(b.start.dateTime||b.start.date)); });

  cols.forEach(c=>{
    const col = document.createElement('div'); col.className='col';
    const h=document.createElement('h3'); h.textContent = fmtDate(c.date); col.appendChild(h);
    c.items.slice(0, MAX_PER_DAY).forEach(ev=>{
      const {name,color}=colorOf(ev);
      const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML = `<span class='dot' style='background:${color}'></span> ${ev.summary||'(제목 없음)'} `;
      const s=new Date(ev.start.dateTime||ev.start.date); const e=new Date(ev.end?.dateTime||ev.end?.date||ev.start.dateTime||ev.start.date);
      const time=document.createElement('div'); time.className='muted'; time.style.fontSize='12px'; time.textContent = (ev.start.date? '종일' : `${fmtTime(s)} ~ ${fmtTime(e)}`);
      col.appendChild(chip); col.appendChild(time);
    });
    parent.appendChild(col);
  });
}

function renderMiniMonth(items){
  const grid=document.getElementById('monthGrid'); const list=document.getElementById('miniList');
  grid.innerHTML=''; list.innerHTML='';
  const today = new Date(); today.setHours(0,0,0,0);
  const y = today.getFullYear(), m = today.getMonth();
  const first = new Date(y,m,1); const last = new Date(y,m+1,0);
  // Build calendar cells starting Monday
  const start = startOfWeek(first);
  const end = new Date(startOfWeek(new Date(y,m+1,1)).getTime() - 86400000);
  const by = groupByDay(items);
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const cell = document.createElement('div'); cell.className='cell';
    const inMonth = d.getMonth()===m;
    const dd=document.createElement('div'); dd.className='d'; dd.textContent=d.getDate(); dd.style.opacity=inMonth?1:.45; cell.appendChild(dd);
    const key=dayKey(d); const evs=by.get(key)||[];
    const pips=document.createElement('div'); pips.className='pips';
    evs.slice(0,3).forEach(ev=>{ const {color}=colorOf(ev); const pip=document.createElement('span'); pip.className='dot'; pip.style.width='6px'; pip.style.height='6px'; pip.style.background=color; pips.appendChild(pip); });
    if(evs.length) cell.appendChild(pips);
    grid.appendChild(cell);
  }
  // Side list: next 10 events
  const sorted = [...items].sort((a,b)=> new Date(a.start.dateTime||a.start.date) - new Date(b.start.dateTime||b.start.date)).slice(0,10);
  sorted.forEach(ev=>{
    const row=document.createElement('div'); row.className='ev';
    const s=new Date(ev.start.dateTime||ev.start.date); const e=new Date(ev.end?.dateTime||ev.end?.date||ev.start.dateTime||ev.start.date);
    const t=document.createElement('div'); t.className='time'; t.textContent = (ev.start.date? '종일' : `${fmtTime(s)}\n~ ${fmtTime(e)}`);
    const m=document.createElement('div');
    const title=document.createElement('div'); title.className='ev-title'; title.textContent=ev.summary||'(제목 없음)';
    const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px'; meta.textContent=fmtDate(s);
    const badge=document.createElement('span'); const {name,color}=colorOf(ev); badge.className='badge'; badge.innerHTML = `<span class='dot' style='background:${color}'></span>${name}`;
    m.appendChild(title); m.appendChild(badge); m.appendChild(meta);
    row.appendChild(t); row.appendChild(m); list.appendChild(row);
  });
}

async function load(){
  const listView=document.getElementById('listView'); listView.innerHTML='<div class="sub">불러오는 중…</div>';
  try{
    const days = parseInt(document.getElementById('daysSel').value,10);
    const {items} = await fetchEvents(days);
    buildLegend(items);
    renderList(items);
    renderWeekBoard(items);
    renderMiniMonth(items);
  }catch(e){
    document.getElementById('listView').innerHTML = `<div class='sub'>오류: ${e.message}</div>`;
  }
}

document.getElementById('reload').addEventListener('click', load);
// deep-link via hash
const map={ '#list':0, '#board':1, '#month':2 };
function applyHash(){ const i = map[location.hash] ?? 0; selTab(i); }
window.addEventListener('hashchange', applyHash); applyHash();

load();
</script>
</body>
</html>
